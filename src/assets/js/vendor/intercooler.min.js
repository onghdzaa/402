var Intercooler=Intercooler||function(){"use strict";"undefined"!=typeof Zepto&&null==$&&($=Zepto);var USE_DATA="true"==$('meta[name="intercoolerjs:use-data-prefix"]').attr("content"),USE_ACTUAL_HTTP_METHOD="true"==$('meta[name="intercoolerjs:use-actual-http-method"]').attr("content"),_MACROS=$.map(["ic-get-from","ic-post-to","ic-put-to","ic-patch-to","ic-delete-from","ic-style-src","ic-attr-src","ic-prepend-from","ic-append-from","ic-action"],function(e){return fixICAttributeName(e)}),_scrollHandler=null,_UUID=1,_readyHandlers=[],_isDependentFunction=function(e,t){if(!e||!t)return!1;var r=e.split(/[\?#]/,1)[0].split("/").filter(function(e){return""!=e}),i=t.split(/[\?#]/,1)[0].split("/").filter(function(e){return""!=e});return""!=r&&""!=i&&(i.slice(0,r.length).join("/")==r.join("/")||r.slice(0,i.length).join("/")==i.join("/"))};function remove(e){e.remove()}function showIndicator(e){0<e.closest(".ic-use-transition").length?(e.data("ic-use-transition",!0),e.removeClass("ic-use-transition")):e.show()}function hideIndicator(e){e.data("ic-use-transition")?(e.data("ic-use-transition",null),e.addClass("ic-use-transition")):e.hide()}function fixICAttributeName(e){return USE_DATA?"data-"+e:e}function getICAttribute(e,t){return e.attr(fixICAttributeName(t))}function setICAttribute(e,t,r){e.attr(fixICAttributeName(t),r)}function prepend(t,e){try{t.prepend(e)}catch(e){log(t,formatError(e),"ERROR")}if(getICAttribute(t,"ic-limit-children")){var r=parseInt(getICAttribute(t,"ic-limit-children"));t.children().length>r&&t.children().slice(r,t.children().length).remove()}}function append(t,e){try{t.append(e)}catch(e){log(t,formatError(e),"ERROR")}if(getICAttribute(t,"ic-limit-children")){var r=parseInt(getICAttribute(t,"ic-limit-children"));t.children().length>r&&t.children().slice(0,t.children().length-r).remove()}}function triggerEvent(e,t,r){$.zepto&&(t=t.split(".").reverse().join(":")),e.trigger(t,r)}function log(e,t,r){if(null==e&&(e=$("body")),triggerEvent(e,"log.ic",[t,r,e]),"ERROR"==r){window.console&&window.console.log("Intercooler Error : "+t);var i=closestAttrValue($("body"),"ic-post-errors-to");i&&$.post(i,{error:t})}}function uuid(){return _UUID++}function icSelectorFor(e){return getICAttributeSelector("ic-id='"+getIntercoolerId(e)+"'")}function parseInterval(e){return log(null,"POLL: Parsing interval string "+e,"DEBUG"),"null"==e||"false"==e||""==e?null:e.lastIndexOf("ms")==e.length-2?parseFloat(e.substr(0,e.length-2)):e.lastIndexOf("s")==e.length-1?1e3*parseFloat(e.substr(0,e.length-1)):1e3}function getICAttributeSelector(e){return"["+fixICAttributeName(e)+"]"}function initScrollHandler(){null==_scrollHandler&&(_scrollHandler=function(){$(getICAttributeSelector("ic-trigger-on='scrolled-into-view'")).each(function(){var e=$(this);isScrolledIntoView(getTriggeredElement(e))&&1!=e.data("ic-scrolled-into-view-loaded")&&(e.data("ic-scrolled-into-view-loaded",!0),fireICRequest(e))})},$(window).scroll(_scrollHandler))}function currentUrl(){return window.location.pathname+window.location.search+window.location.hash}function createDocument(e){var t=null;return/<(html|body)/i.test(e)?(t=document.documentElement.cloneNode()).innerHTML=e:(t=document.documentElement.cloneNode(!0)).querySelector("body").innerHTML=e,$(t)}function getTarget(e){return getTargetImpl(e,"ic-target")}function getTargetImpl(e,t){var r=$(e).closest(getICAttributeSelector(t)),i=getICAttribute(r,t);return"this"==i?r:i&&0!=i.indexOf("this.")?0==i.indexOf("closest ")?e.closest(i.substr(8)):0==i.indexOf("find ")?e.find(i.substr(5)):$(i):e}function processHeaders(r,e){triggerEvent(r=$(r),"beforeHeaders.ic",[r,e]),log(r,"response headers: "+e.getAllResponseHeaders(),"DEBUG");var t,i=null;if(e.getResponseHeader("X-IC-Title")&&(document.title=e.getResponseHeader("X-IC-Title")),e.getResponseHeader("X-IC-Refresh")){var n=e.getResponseHeader("X-IC-Refresh").split(",");log(r,"X-IC-Refresh: refreshing "+n,"DEBUG"),$.each(n,function(e,t){refreshDependencies(t.replace(/ /g,""),r)})}e.getResponseHeader("X-IC-Script")&&(log(r,"X-IC-Script: evaling "+e.getResponseHeader("X-IC-Script"),"DEBUG"),globalEval(e.getResponseHeader("X-IC-Script"),[["elt",r]])),e.getResponseHeader("X-IC-Redirect")&&(log(r,"X-IC-Redirect: redirecting to "+e.getResponseHeader("X-IC-Redirect"),"DEBUG"),window.location=e.getResponseHeader("X-IC-Redirect")),"true"==e.getResponseHeader("X-IC-CancelPolling")&&cancelPolling(r.closest(getICAttributeSelector("ic-poll"))),"true"==e.getResponseHeader("X-IC-ResumePolling")&&(setICAttribute(t=r.closest(getICAttributeSelector("ic-poll")),"ic-pause-polling",null),startPolling(t));e.getResponseHeader("X-IC-SetPollInterval")&&(cancelPolling(t=r.closest(getICAttributeSelector("ic-poll"))),setICAttribute(t,"ic-poll",e.getResponseHeader("X-IC-SetPollInterval")),startPolling(t));e.getResponseHeader("X-IC-Open")&&(log(r,"X-IC-Open: opening "+e.getResponseHeader("X-IC-Open"),"DEBUG"),window.open(e.getResponseHeader("X-IC-Open")));var o=e.getResponseHeader("X-IC-Trigger");if(o)if(log(r,"X-IC-Trigger: found trigger "+o,"DEBUG"),i=getTarget(r),e.getResponseHeader("X-IC-Trigger-Data")){var s=$.parseJSON(e.getResponseHeader("X-IC-Trigger-Data"));triggerEvent(i,o,s)}else 0<=o.indexOf("{")?$.each($.parseJSON(o),function(e,t){triggerEvent(i,e,t)}):triggerEvent(i,o,[]);var a=e.getResponseHeader("X-IC-Set-Local-Vars");if(a&&$.each($.parseJSON(a),function(e,t){localStorage.setItem(e,t)}),e.getResponseHeader("X-IC-Remove")&&r){var c=e.getResponseHeader("X-IC-Remove"),l=parseInterval(c+="");log(r,"X-IC-Remove header found.","DEBUG"),i=getTarget(r),"true"==c||null==l?remove(i):(i.addClass("ic-removing"),setTimeout(function(){remove(i)},l))}return triggerEvent(r,"afterHeaders.ic",[r,e]),!0}function beforeRequest(e){e.addClass("disabled"),e.data("ic-request-in-flight",!0)}function requestCleanup(e,t){0<e.length&&hideIndicator(e),t.removeClass("disabled"),t.data("ic-request-in-flight",!1),t.data("ic-next-request")&&(t.data("ic-next-request").req(),t.data("ic-next-request",null))}function replaceOrAddMethod(e,t){if("string"!==$.type(e))return e.append("_method",t),e;var r=/(&|^)_method=[^&]*/,i="&_method="+t;return r.test(e)?e.replace(r,i):e+i}function isIdentifier(e){return/^[$A-Z_][0-9A-Z_$]*$/i.test(e)}function globalEval(e,t){var r=[],i=[];if(t)for(var n=0;n<t.length;n++)r.push(t[n][0]),i.push(t[n][1]);return isIdentifier(e)?window[e].apply(this,i):window.eval.call(window,"(function ("+r.join(", ")+") {"+e+"})").apply(this,i)}function closestAttrValue(e,t){var r=$(e).closest(getICAttributeSelector(t));return 0<r.length?getICAttribute(r,t):null}function formatError(e){var t=e.toString()+"\n";try{t+=e.stack}catch(e){}return t}function handleRemoteRequest(a,i,n,o,c){beforeRequest(a),o=replaceOrAddMethod(o,i);var l=findIndicator(a);0<l.length&&showIndicator(l);var u=uuid(),s=new Date,e={type:USE_ACTUAL_HTTP_METHOD?i:"GET"==i?"GET":"POST",url:n,data:o,dataType:"text",headers:{Accept:"text/html-partial, */*; q=0.9","X-IC-Request":!0,"X-HTTP-Method-Override":i},beforeSend:function(e,t){triggerEvent(a,"beforeSend.ic",[a,o,t,e,u]),log(a,"before AJAX request "+u+": "+i+" to "+n,"DEBUG");var r=closestAttrValue(a,"ic-on-beforeSend");r&&globalEval(r,[["elt",a],["data",o],["settings",t],["xhr",e]]),maybeInvokeLocalAction(a,"-beforeSend")},success:function(e,t,r){triggerEvent(a,"success.ic",[a,e,t,r,u]),log(a,"AJAX request "+u+" was successful.","DEBUG");var i=closestAttrValue(a,"ic-on-success");if(!i||0!=globalEval(i,[["elt",a],["data",e],["textStatus",t],["xhr",r]])){var n=new Date;try{if(processHeaders(a,r)){log(a,"Processed headers for request "+u+" in "+(new Date-n)+"ms","DEBUG");var o=new Date;if(r.getResponseHeader("X-IC-PushURL")||"true"==closestAttrValue(a,"ic-push-url"))try{requestCleanup(l,a);var s=r.getResponseHeader("X-IC-PushURL")||closestAttrValue(a,"ic-src");if(!_history)throw"History support not enabled";_history.snapshotForHistory(s)}catch(e){log(a,"Error during history snapshot for "+u+": "+formatError(e),"ERROR")}c(e,t,a,r),log(a,"Process content for request "+u+" in "+(new Date-o)+"ms","DEBUG")}triggerEvent(a,"after.success.ic",[a,e,t,r,u]),maybeInvokeLocalAction(a,"-success")}catch(e){log(a,"Error processing successful request "+u+" : "+formatError(e),"ERROR")}}},error:function(e,t,r){triggerEvent(a,"error.ic",[a,t,r,e]);var i=closestAttrValue(a,"ic-on-error");i&&globalEval(i,[["elt",a],["status",t],["str",r],["xhr",e]]),processHeaders(a,e),maybeInvokeLocalAction(a,"-error"),log(a,"AJAX request "+u+" to "+n+" experienced an error: "+r,"ERROR")},complete:function(e,t){log(a,"AJAX request "+u+" completed in "+(new Date-s)+"ms","DEBUG"),requestCleanup(l,a);try{$.contains(document,a[0])?triggerEvent(a,"complete.ic",[a,o,t,e,u]):triggerEvent($("body"),"complete.ic",[a,o,t,e,u])}catch(e){log(a,"Error during complete.ic event for "+u+" : "+formatError(e),"ERROR")}var r=closestAttrValue(a,"ic-on-complete");r&&globalEval(r,[["elt",a],["xhr",e],["status",t]]),maybeInvokeLocalAction(a,"-complete")}};"string"!=$.type(o)&&(e.dataType=null,e.processData=!1,e.contentType=!1),triggerEvent($(document),"beforeAjaxSend.ic",[e,a]),e.cancel?requestCleanup(l,a):$.ajax(e)}function findIndicator(e){var t=null;if(getICAttribute(e=$(e),"ic-indicator"))t=$(getICAttribute(e,"ic-indicator")).first();else if(0==(t=e.find(".ic-indicator").first()).length){var r=closestAttrValue(e,"ic-indicator");r?t=$(r).first():e.next().is(".ic-indicator")&&(t=e.next())}return t}function processIncludes(r,e){if(0==$.trim(e).indexOf("{")){var t=$.parseJSON(e);$.each(t,function(e,t){r=appendData(r,e,t)})}else $(e).each(function(){var e=$(this).serializeArray();$.each(e,function(e,t){r=appendData(r,t.name,t.value)})});return r}function processLocalVars(r,e){return $(e.split(",")).each(function(){var e=$.trim(this),t=localStorage.getItem(e);t&&(r=appendData(r,e,t))}),r}function appendData(e,t,r){return"string"===$.type(e)?("string"!==$.type(r)&&(r=JSON.stringify(r)),e+"&"+t+"="+encodeURIComponent(r)):(e.append(t,r),e)}function getParametersForElement(e,t,r){var i=getTarget(t),n=null;if(t.is("form")&&"multipart/form-data"==t.attr("enctype"))n=appendData(n=new FormData(t[0]),"ic-request",!0);else{n="ic-request=true";var o=t.closest("form");if(t.is("form")||"GET"!=e&&0<o.length){n+="&"+o.serialize();var s=t.data("ic-last-clicked-button");s&&(n=appendData(n,s.name,s.value))}else n+="&"+t.serialize()}var a=closestAttrValue(t,"ic-prompt");if(a){var c=prompt(a);if(!c)return null;var l=closestAttrValue(t,"ic-prompt-name")||"ic-prompt-value";n=appendData(n,l,c)}t.attr("id")&&(n=appendData(n,"ic-element-id",t.attr("id"))),t.attr("name")&&(n=appendData(n,"ic-element-name",t.attr("name"))),getICAttribute(i,"ic-id")&&(n=appendData(n,"ic-id",getICAttribute(i,"ic-id"))),i.attr("id")&&(n=appendData(n,"ic-target-id",i.attr("id"))),r&&r.attr("id")&&(n=appendData(n,"ic-trigger-id",r.attr("id"))),r&&r.attr("name")&&(n=appendData(n,"ic-trigger-name",r.attr("name")));var u=closestAttrValue(t,"ic-include");u&&(n=processIncludes(n,u));var d=closestAttrValue(t,"ic-local-vars");d&&(n=processLocalVars(n,d)),$(getICAttributeSelector("ic-global-include")).each(function(){n=processIncludes(n,getICAttribute($(this),"ic-global-include"))}),n=appendData(n,"ic-current-url",currentUrl());var g=closestAttrValue(t,"ic-select-from-response");return g&&(n=appendData(n,"ic-select-from-response",g)),log(t,"request parameters "+n,"DEBUG"),n}function maybeSetIntercoolerInfo(e){getIntercoolerId(getTarget(e)),1!=e.data("elementAdded.ic")&&(e.data("elementAdded.ic",!0),triggerEvent(e,"elementAdded.ic"))}function getIntercoolerId(e){return getICAttribute(e,"ic-id")||setICAttribute(e,"ic-id",uuid()),getICAttribute(e,"ic-id")}function processNodes(e){1<(e=$(e)).length?e.each(function(){processNodes(this)}):(processMacros(e),processSources(e),processPolling(e),processEventSources(e),processTriggerOn(e),processRemoveAfter(e),processAddClasses(e),processRemoveClasses(e))}function fireReadyStuff(r){triggerEvent(r,"nodesProcessed.ic"),$.each(_readyHandlers,function(e,t){try{t(r)}catch(e){log(r,formatError(e),"ERROR")}})}function autoFocus(e){e.find("[autofocus]").last().focus()}function processMacros(r){$.each(_MACROS,function(e,t){0==r.closest(".ic-ignore").length&&(r.is("["+t+"]")&&processMacro(t,r),r.find("["+t+"]").each(function(){var e=$(this);0==e.closest(".ic-ignore").length&&processMacro(t,e)}))})}function processSources(e){0==e.closest(".ic-ignore").length&&(e.is(getICAttributeSelector("ic-src"))&&maybeSetIntercoolerInfo(e),e.find(getICAttributeSelector("ic-src")).each(function(){var e=$(this);0==e.closest(".ic-ignore").length&&maybeSetIntercoolerInfo(e)}))}function processPolling(e){0==e.closest(".ic-ignore").length&&(e.is(getICAttributeSelector("ic-poll"))&&(maybeSetIntercoolerInfo(e),startPolling(e)),e.find(getICAttributeSelector("ic-poll")).each(function(){var e=$(this);0==e.closest(".ic-ignore").length&&(maybeSetIntercoolerInfo(e),startPolling(e))}))}function processTriggerOn(e){0==e.closest(".ic-ignore").length&&(handleTriggerOn(e),e.find(getICAttributeSelector("ic-trigger-on")).each(function(){var e=$(this);0==e.closest(".ic-ignore").length&&handleTriggerOn(e)}))}function processRemoveAfter(e){0==e.closest(".ic-ignore").length&&(handleRemoveAfter(e),e.find(getICAttributeSelector("ic-remove-after")).each(function(){var e=$(this);0==e.closest(".ic-ignore").length&&handleRemoveAfter(e)}))}function processAddClasses(e){0==e.closest(".ic-ignore").length&&(handleAddClasses(e),e.find(getICAttributeSelector("ic-add-class")).each(function(){var e=$(this);0==e.closest(".ic-ignore").length&&handleAddClasses(e)}))}function processRemoveClasses(e){0==e.closest(".ic-ignore").length&&(handleRemoveClasses(e),e.find(getICAttributeSelector("ic-remove-class")).each(function(){var e=$(this);0==e.closest(".ic-ignore").length&&handleRemoveClasses(e)}))}function processEventSources(e){0==e.closest(".ic-ignore").length&&(handleEventSource(e),e.find(getICAttributeSelector("ic-sse-src")).each(function(){var e=$(this);0==e.closest(".ic-ignore").length&&handleEventSource(e)}))}function startPolling(t){if(null==t.data("ic-poll-interval-id")&&"true"!=getICAttribute(t,"ic-pause-polling")){var e=parseInterval(getICAttribute(t,"ic-poll"));if(null!=e){var r=icSelectorFor(t),i=parseInt(getICAttribute(t,"ic-poll-repeats"))||-1,n=0;log(t,"POLL: Starting poll for element "+r,"DEBUG");var o=setInterval(function(){var e=$(r);triggerEvent(t,"onPoll.ic",e),0==e.length||n==i||t.data("ic-poll-interval-id")!=o?(log(t,"POLL: Clearing poll for element "+r,"DEBUG"),clearTimeout(o)):fireICRequest(e),n++},e);t.data("ic-poll-interval-id",o)}}}function cancelPolling(e){null!=e.data("ic-poll-interval-id")&&(clearTimeout(e.data("ic-poll-interval-id")),e.data("ic-poll-interval-id",null))}function refreshDependencies(r,i){log(i,"refreshing dependencies for path "+r,"DEBUG"),$(getICAttributeSelector("ic-src")).each(function(){var e=!1,t=$(this);"GET"==verbFor(t)&&"ignore"!=getICAttribute(t,"ic-deps")&&(isDependent(r,getICAttribute(t,"ic-src"))?null!=i&&$(i)[0]==t[0]||(fireICRequest(t),e=!0):!isICDepsDependent(r,getICAttribute(t,"ic-deps"))&&"*"!=getICAttribute(t,"ic-deps")||null!=i&&$(i)[0]==t[0]||(fireICRequest(t),e=!0)),e&&log(t,"depends on path "+r+", refreshing...","DEBUG")})}function isICDepsDependent(e,t){if(t)for(var r=t.split(","),i=0;i<r.length;i++){if(isDependent(e,r[i].trim()))return 1}}function isDependent(e,t){return!!_isDependentFunction(e,t)}function verbFor(e){return getICAttribute(e=$(e),"ic-verb")?getICAttribute(e,"ic-verb").toUpperCase():"GET"}function eventFor(e,t){return"default"==e?(t=$(t)).is("button")?"click":t.is("form")?"submit":t.is("input, textarea, select, button")?"change":"click":e}function preventDefault(e,t){return e.is("form")||e.is('input[type="submit"], button')&&1==e.closest("form").length||e.is("a")&&e.is("[href]")&&0!=e.attr("href").indexOf("#")}function handleRemoveAfter(e){if(getICAttribute(e=$(e),"ic-remove-after")){var t=parseInterval(getICAttribute(e,"ic-remove-after"));setTimeout(function(){remove(e)},t)}}function parseAndApplyClass(e,t,r){var i="",n=50;if(0<e.indexOf(":")){var o=e.split(":");i=o[0],n=parseInterval(o[1])}else i=e;setTimeout(function(){t[r](i)},n)}function handleAddClasses(e){if(getICAttribute(e=$(e),"ic-add-class"))for(var t=getICAttribute(e,"ic-add-class").split(","),r=t.length,i=0;i<r;i++)parseAndApplyClass($.trim(t[i]),e,"addClass")}function handleRemoveClasses(e){if(getICAttribute(e=$(e),"ic-remove-class"))for(var t=getICAttribute(e,"ic-remove-class").split(","),r=t.length,i=0;i<r;i++)parseAndApplyClass($.trim(t[i]),e,"removeClass")}function handleEventSource(e){if(getICAttribute(e=$(e),"ic-sse-src")){var t=initEventSource(e,getICAttribute(e,"ic-sse-src"));e.data("ic-event-sse-source",t),e.data("ic-event-sse-map",{})}}function initEventSource(t,e){var r=Intercooler._internal.initEventSource(e);return r.onmessage=function(e){processICResponse(e.data,t,!1)},r}function registerSSE(e,t){var r=e.data("ic-event-sse-source"),i=e.data("ic-event-sse-map");r.addEventListener&&1!=i[t]&&r.addEventListener(t,function(){e.find(getICAttributeSelector("ic-trigger-on")).each(function(){var e=$(this);e.attr("ic-trigger-on")=="sse:"+t&&fireICRequest(e)})})}function getTriggeredElement(e){var t=getICAttribute(e,"ic-trigger-from");return t?"document"==t?$(document):"window"==t?$(window):$(t):e}function handleTriggerOn(o){if(getICAttribute(o,"ic-trigger-on"))if(o.is("form")&&o.on("click focus","input, button, select, textarea",function(e){$(this).is('input[type="submit"], button')&&$(this).is("[name]")?o.data("ic-last-clicked-button",{name:$(this).attr("name"),value:$(this).val()}):o.data("ic-last-clicked-button",null)}),"load"==getICAttribute(o,"ic-trigger-on"))fireICRequest(o);else if("scrolled-into-view"==getICAttribute(o,"ic-trigger-on"))initScrollHandler(),setTimeout(function(){triggerEvent($(window),"scroll")},100);else{if(0==(s=getICAttribute(o,"ic-trigger-on").split(" "))[0].indexOf("sse:")){var e=o.closest(getICAttributeSelector("ic-sse-src"));e&&registerSSE(e,s[0].substr(4))}else{var s,t=eventFor((s=getICAttribute($(o),"ic-trigger-on").split(" "))[0],$(o));$(getTriggeredElement(o)).on(t,function(e){var t=closestAttrValue(o,"ic-on-beforeTrigger");if(t&&0==globalEval(t,[["elt",o],["evt",e],["elt",o]]))return log(o,"ic-trigger cancelled by ic-on-beforeTrigger","DEBUG"),!1;if("changed"==s[1]){var r=o.val(),i=o.data("ic-previous-val");o.data("ic-previous-val",r),r!=i&&fireICRequest(o)}else if("once"==s[1]){var n=o.data("ic-already-triggered");o.data("ic-already-triggered",!0),!0!==n&&fireICRequest(o)}else fireICRequest(o);return!preventDefault(o,e)||(e.preventDefault(),!1)}),t&&0==t.indexOf("timeout:")&&setTimeout(function(){$(getTriggeredElement(o)).trigger(t)},parseInterval(t.split(":")[1]))}}}function macroIs(e,t){return e==fixICAttributeName(t)}function processMacro(e,t){macroIs(e,"ic-post-to")&&(setIfAbsent(t,"ic-src",getICAttribute(t,"ic-post-to")),setIfAbsent(t,"ic-verb","POST"),setIfAbsent(t,"ic-trigger-on","default"),setIfAbsent(t,"ic-deps","ignore")),macroIs(e,"ic-put-to")&&(setIfAbsent(t,"ic-src",getICAttribute(t,"ic-put-to")),setIfAbsent(t,"ic-verb","PUT"),setIfAbsent(t,"ic-trigger-on","default"),setIfAbsent(t,"ic-deps","ignore")),macroIs(e,"ic-patch-to")&&(setIfAbsent(t,"ic-src",getICAttribute(t,"ic-patch-to")),setIfAbsent(t,"ic-verb","PATCH"),setIfAbsent(t,"ic-trigger-on","default"),setIfAbsent(t,"ic-deps","ignore")),macroIs(e,"ic-get-from")&&(setIfAbsent(t,"ic-src",getICAttribute(t,"ic-get-from")),setIfAbsent(t,"ic-trigger-on","default"),setIfAbsent(t,"ic-deps","ignore")),macroIs(e,"ic-delete-from")&&(setIfAbsent(t,"ic-src",getICAttribute(t,"ic-delete-from")),setIfAbsent(t,"ic-verb","DELETE"),setIfAbsent(t,"ic-trigger-on","default"),setIfAbsent(t,"ic-deps","ignore")),macroIs(e,"ic-action")&&setIfAbsent(t,"ic-trigger-on","default");var r=null;if(macroIs(e,"ic-style-src")){var i=(r=getICAttribute(t,"ic-style-src").split(":"))[0];setIfAbsent(t,"ic-src",r[1]),setIfAbsent(t,"ic-target","this.style."+i)}if(macroIs(e,"ic-attr-src")){var n=(r=getICAttribute(t,"ic-attr-src").split(":"))[0];setIfAbsent(t,"ic-src",r[1]),setIfAbsent(t,"ic-target","this."+n)}macroIs(e,"ic-prepend-from")&&(setIfAbsent(t,"ic-src",getICAttribute(t,"ic-prepend-from")),setIfAbsent(t,"ic-swap-style","prepend")),macroIs(e,"ic-append-from")&&(setIfAbsent(t,"ic-src",getICAttribute(t,"ic-append-from")),setIfAbsent(t,"ic-swap-style","append"))}function setIfAbsent(e,t,r){null==getICAttribute(e,t)&&setICAttribute(e,t,r)}function isScrolledIntoView(e){if(0!=(e=$(e)).height()||0!=e.width()){var t=$(window).scrollTop(),r=t+$(window).height(),i=e.offset().top,n=i+e.height();return t<=n&&i<=r&&n<=r&&t<=i}}function maybeScrollToTarget(e,t){if("false"!=closestAttrValue(e,"ic-scroll-to-target")&&("true"==closestAttrValue(e,"ic-scroll-to-target")||"true"==closestAttrValue(t,"ic-scroll-to-target"))){var r=-50;closestAttrValue(e,"ic-scroll-offset")?r=parseInt(closestAttrValue(e,"ic-scroll-offset")):closestAttrValue(t,"ic-scroll-offset")&&(r=parseInt(closestAttrValue(t,"ic-scroll-offset")));var i=t.offset().top,n=$(window).scrollTop(),o=n+window.innerHeight;(i<n||o<i)&&(r+=i,$("html,body").animate({scrollTop:r},400))}}function getTransitionDuration(e,t){var r=closestAttrValue(e,"ic-transition-duration");if(r)return parseInterval(r);if(r=closestAttrValue(t,"ic-transition-duration"))return parseInterval(r);var i=0,n=(t=$(t)).css("transition-duration");n&&(i+=parseInterval(n));var o=t.css("transition-delay");return o&&(i+=parseInterval(o)),i}function closeSSESource(t){var e=t.data("ic-event-sse-source");try{e&&e.close()}catch(e){log(t,"Error closing ServerSentEvent source"+e,"ERROR")}}function beforeSwapCleanup(e){e.find(getICAttributeSelector("ic-sse-src")).each(function(){closeSSESource($(this))}),triggerEvent(e,"beforeSwap.ic")}function processICResponse(e,t,r,i){if(e&&""!=e&&" "!=e){log(t,"response content: \n"+e,"DEBUG");var n=getTarget(t),o=closestAttrValue(t,"ic-transform-response");o&&(e=globalEval(o,[["content",e],["url",i],["elt",t]]));var s=maybeFilter(e,closestAttrValue(t,"ic-select-from-response"));"true"==closestAttrValue(t,"ic-fix-ids")&&fixIDs(s);if(0==n.length)return void log(t,"Invalid target for element: "+getICAttribute(t.closest(getICAttributeSelector("ic-target")),"ic-target"),"ERROR");var a=getTransitionDuration(t,n);n.addClass("ic-transitioning"),setTimeout(function(){try{!function(){if("true"==closestAttrValue(t,"ic-replace-target")){try{beforeSwapCleanup(n),closeSSESource(n),n.replaceWith(s),n=s}catch(e){log(t,formatError(e),"ERROR")}processNodes(s),fireReadyStuff(n),autoFocus(n)}else{if("prepend"==getICAttribute(t,"ic-swap-style"))prepend(n,s),processNodes(s),fireReadyStuff(n),autoFocus(n);else if("append"==getICAttribute(t,"ic-swap-style"))append(n,s),processNodes(s),fireReadyStuff(n),autoFocus(n);else{try{beforeSwapCleanup(n),n.empty().append(s)}catch(e){log(t,formatError(e),"ERROR")}n.children().each(function(){processNodes(this)}),fireReadyStuff(n),autoFocus(n)}1!=r&&maybeScrollToTarget(t,n)}}()}catch(e){log(t,"Error during content swap : "+formatError(e),"ERROR")}setTimeout(function(){try{n.removeClass("ic-transitioning"),_history&&_history.updateHistory(),triggerEvent(n,"complete_transition.ic",[n])}catch(e){log(t,"Error during transition complete : "+formatError(e),"ERROR")}},20)},a)}else log(t,"Empty response, nothing to do here.","DEBUG")}function maybeFilter(e,t){var r;if($.zepto){var i=createDocument(e);r=$(i).find("body").contents()}else r=$($.parseHTML(e,null,!0));return t?walkTree(r,t).contents():r}function walkTree(e,t){return e.filter(t).add(e.find(t))}function fixIDs(e){var r={};walkTree(e,"[id]").each(function(){for(var e,t=$(this).attr("id");e="ic-fixed-id-"+uuid(),0<$("#"+e).length;);r[t]=e,$(this).attr("id",e)}),walkTree(e,"label[for]").each(function(){var e=$(this).attr("for");$(this).attr("for",r[e]||e)}),walkTree(e,"*").each(function(){$.each(this.attributes,function(){-1!==this.value.indexOf("#")&&(this.value=this.value.replace(/#([-_A-Za-z0-9]+)/g,function(e,t){return"#"+(r[t]||t)}))})})}function getStyleTarget(e){var t=closestAttrValue(e,"ic-target");return t&&0==t.indexOf("this.style.")?t.substr(11):null}function getAttrTarget(e){var t=closestAttrValue(e,"ic-target");return t&&0==t.indexOf("this.")?t.substr(5):null}function fireICRequest(s,a){var c=s=$(s);s.is(getICAttributeSelector("ic-src"))||null!=getICAttribute(s,"ic-action")||(s=s.closest(getICAttributeSelector("ic-src")));var e=closestAttrValue(s,"ic-confirm");if((!e||confirm(e))&&("true"!=closestAttrValue(s,"ic-disable-when-doc-hidden")||!document.hidden)&&("true"!=closestAttrValue(s,"ic-disable-when-doc-inactive")||document.hasFocus())&&0<s.length){var l=uuid();s.data("ic-event-id",l);var u=function(){if(1!=s.data("ic-request-in-flight")){if(s.data("ic-event-id")==l){var t=getStyleTarget(s),r=t?null:getAttrTarget(s),i=verbFor(s),n=getICAttribute(s,"ic-src");if(n){var e=a||function(e){t?s.css(t,e):r?s.attr(r,e):(processICResponse(e,s,!1,n),"GET"!=i&&refreshDependencies(getICAttribute(s,"ic-src"),s))},o=getParametersForElement(i,s,c);o&&handleRemoteRequest(s,i,n,o,e)}maybeInvokeLocalAction(s,"")}}else s.data("ic-next-request",{req:u})},t=closestAttrValue(s,"ic-trigger-delay");t?setTimeout(u,parseInterval(t)):u()}}function maybeInvokeLocalAction(e,t){var r=getICAttribute(e,"ic"+t+"-action");r&&invokeLocalAction(e,r,t)}function invokeLocalAction(e,t,r){var i=closestAttrValue(e,"ic"+r+"-action-target");null===i&&""!==r&&(i=closestAttrValue(e,"ic-action-target"));var o=null;o=i?getTargetImpl(e,"ic-action-target"):getTarget(e);var n=t.split(";"),s=[],a=0;$.each(n,function(e,t){var r=$.trim(t),i=r,n=[];0<r.indexOf(":")&&(i=r.substr(0,r.indexOf(":")),n=computeArgs(r.substr(r.indexOf(":")+1,r.length))),""==i||("delay"==i?(null==a&&(a=0),a+=parseInterval(n[0]+"")):(null==a&&(a=420),s.push([a,makeApplyAction(o,i,n)]),a=null))}),a=0,$.each(s,function(e,t){a+=t[0],setTimeout(t[1],a)})}function computeArgs(args){try{return eval("["+args+"]")}catch(e){return[$.trim(args)]}}function makeApplyAction(t,r,i){return function(){var e=t[r]||window[r];e?e.apply(t,i):log(t,"Action "+r+" was not found","ERROR")}}function newIntercoolerHistory(s,a,n,i){var e,o="ic-history-support",c="ic-hist-elt-",l=JSON.parse(s.getItem(o)),r=null;function u(){for(var e=[],t=0;t<s.length;t++)0==s.key(t).indexOf(c)&&e.push(s.key(t));for(var r=0;r<e.length;r++)s.removeItem(e[r]);s.removeItem(o),l={slotLimit:n,historyVersion:i,lruList:[]}}function d(e){var t=l.lruList,r=t.indexOf(e),i=f($("body"));if(0<=r)log(i,"URL found in LRU list, moving to end","INFO"),t.splice(r,1),t.push(e);else if(log(i,"URL not found in LRU list, adding","INFO"),t.push(e),t.length>l.slotLimit){var n=t.shift();log(i,"History overflow, removing local history for "+n,"INFO"),s.removeItem(c+n)}return s.setItem(o,JSON.stringify(l)),t}function g(e,t,r){var i={url:r,id:c+r,content:e,yOffset:t,timestamp:(new Date).getTime()};return d(r),function(t){var r=JSON.stringify(t);try{s.setItem(t.id,r)}catch(e){try{u(),s.setItem(t.id,r)}catch(e){log(f($("body")),"Unable to save intercooler history with entire history cleared, is something else eating local storage? History Limit:"+n,"ERROR")}}}(i),i}function t(e){if(null==e.onpopstate||1!=e.onpopstate["ic-on-pop-state-handler"]){var t=e.onpopstate;e.onpopstate=function(e){triggerEvent(f($("body")),"handle.onpopstate.ic"),function(e){var t=e.state;if(t&&t["ic-id"]){var r=JSON.parse(s.getItem(t["ic-id"]));if(r)return processICResponse(r.content,f($("body")),!0),r.yOffset&&window.scrollTo(0,r.yOffset),1;$.get(currentUrl(),{"ic-restore-history":!0},function(e,t){processICResponse(f(createDocument(e)).html(),f($("body")),!0)})}return}(e)||t&&t(e),triggerEvent(f($("body")),"pageLoad.ic")},e.onpopstate["ic-on-pop-state-handler"]=!0}}function f(e){var t=e.find(getICAttributeSelector("ic-history-elt"));return 0<t.length?t:e}return null!=(e=l)&&e.slotLimit==n&&e.historyVersion==i&&null!=e.lruList||(log(f($("body")),"Intercooler History configuration changed, clearing history","INFO"),u()),null==l&&(l={slotLimit:n,historyVersion:i,lruList:[]}),{clearHistory:u,updateHistory:function(){r&&(function(e,t,r,i){var n=g(r,i,t);a.replaceState({"ic-id":n.id},"","");var o=f($("body")),s=g(o.html(),window.pageYOffset,e);a.pushState({"ic-id":s.id},"",e),triggerEvent(o,"pushUrl.ic",[o,s])}(r.newUrl,currentUrl(),r.oldHtml,r.yOffset),r=null)},addPopStateHandler:t,snapshotForHistory:function(e){var t=f($("body"));triggerEvent(t,"beforeHistorySnapshot.ic",[t]),r={newUrl:e,oldHtml:t.html(),yOffset:window.pageYOffset}},_internal:{addPopStateHandler:t,supportData:function(){return l},dumpLocalStorage:function(){var e="",t=[];for(var r in s)t.push(r);t.sort();var i=0;for(var n in t){var o=2*s[t[n]].length;i+=o,e+=t[n]+"="+(o/1024/1024).toFixed(2)+" MB\n"}return e+"\nTOTAL LOCAL STORAGE: "+(i/1024/1024).toFixed(2)+" MB"},updateLRUList:d}}}function getSlotLimit(){return 20}function refresh(e){return("string"==typeof e||e instanceof String?refreshDependencies:fireICRequest)(e),Intercooler}var _history=null;try{_history=newIntercoolerHistory(localStorage,window.history,getSlotLimit(),.1)}catch(e){log($("body"),"Could not initialize history","WARN")}function init(){var e=$("body");processNodes(e),fireReadyStuff(e),_history&&_history.addPopStateHandler(window),$.zepto&&($("body").data("zeptoDataTest",{}),"string"==typeof $("body").data("zeptoDataTest")&&console.log("!!!! Please include the data module with Zepto!  Intercooler requires full data support to function !!!!")),location.search&&0<=location.search.indexOf("ic-launch-debugger=true")&&Intercooler.debug()}return $.ajaxTransport&&$.ajaxTransport("text",function(e,t){if("#"!=t.url[0])return null;var n=fixICAttributeName("ic-local-"),r=$(t.url),o=[],s=200,a="OK";r.each(function(e,t){$.each(t.attributes,function(e,t){if(t.name.substr(0,n.length)==n){var r=t.name.substring(n.length);if("status"==r){var i=t.value.match(/(\d+)\s?(.*)/);a=null!=i?(s=i[1],i[2]):(s="500","Attribute Error")}else o.push(r+": "+t.value)}})});var i=0<r.length?r.html():"";return{send:function(e,t){t(s,a,{html:i},o.join("\n"))},abort:function(){}}}),$(function(){init()}),{refresh:refresh,history:_history,triggerRequest:fireICRequest,processNodes:processNodes,closestAttrValue:closestAttrValue,verbFor:verbFor,isDependent:isDependent,getTarget:getTarget,processHeaders:processHeaders,setIsDependentFunction:function(e){_isDependentFunction=e},ready:function(e){_readyHandlers.push(e)},debug:function(){var e=closestAttrValue("body","ic-debugger-url")||"https://intercoolerreleases-leaddynocom.netdna-ssl.com/intercooler-debugger.js";$.getScript(e).fail(function(e,t,r){log($("body"),formatError(r),"ERROR")})},_internal:{init:init,replaceOrAddMethod:replaceOrAddMethod,initEventSource:function(e){return new EventSource(e)},globalEval:globalEval}}}();